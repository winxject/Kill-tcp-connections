#include <iostream>
#include <fstream>
#include <vector>
#include <thread>
#include <chrono>
#include <cstdlib>
#include <sstream>
#include <unordered_set>
#include <regex>
#ifdef _WIN32
#include <windows.h>
#else
#include <unistd.h>
#endif

using namespace std;

// Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨ÙˆØ±ØªØ§Øª Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡Ø© (Reverse Shell, RATs, VPN Exploits)
unordered_set<int> suspicious_ports = {4444, 5555, 8080, 1337, 3389, 9001, 6666, 7777, 9999, 1080};

// Ø¯Ø§Ù„Ø© Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ø£ÙˆØ§Ù…Ø± ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬
string exec_command(const char* cmd) {
    char buffer[256];
    string result;
    FILE* pipe;
    
    #ifdef _WIN32
        pipe = _popen(cmd, "r");
    #else
        pipe = popen(cmd, "r");
    #endif

    if (!pipe) return "ERROR";
    while (fgets(buffer, sizeof(buffer), pipe) != nullptr) {
        result += buffer;
    }

    #ifdef _WIN32
        _pclose(pipe);
    #else
        pclose(pipe);
    #endif

    return result;
}

// Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù€ IP Ù…Ø­Ù„ÙŠÙ‹Ø§
bool is_local_ip(const string& ip) {
    return regex_match(ip, regex("(192\\.168\\.|10\\.|127\\.|172\\.(1[6-9]|2[0-9]|3[0-1]))"));
}

// Ø¯Ø§Ù„Ø© Ù„Ø­Ø¸Ø± Ø¹Ù†ÙˆØ§Ù† IP
void block_ip(const string& ip) {
    if (is_local_ip(ip)) return; // Ù„Ø§ ØªØ­Ø¸Ø± Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
    cout << "[!] Blocking IP: " << ip << endl;
    string command;
    #ifdef _WIN32
        command = "netsh advfirewall firewall add rule name='Block Hacker' dir=in action=block remoteip=" + ip;
    #else
        command = "sudo iptables -A INPUT -s " + ip + " -j DROP";
    #endif
    system(command.c_str());
}

// Ø¯Ø§Ù„Ø© Ù„Ø­Ø¸Ø± Ø¨ÙˆØ±Øª Ù…Ø¹ÙŠÙ†
void block_port(int port) {
    cout << "[!] Blocking Port: " << port << endl;
    string command;
    #ifdef _WIN32
        command = "netsh advfirewall firewall add rule name='Block Port' dir=in action=block protocol=TCP localport=" + to_string(port);
    #else
        command = "sudo iptables -A INPUT -p tcp --dport " + to_string(port) + " -j DROP";
    #endif
    system(command.c_str());
}

// Ø¯Ø§Ù„Ø© Ù„Ù…Ù‡Ø§Ø¬Ù…Ø© Ø³ÙŠØ±ÙØ± Ø§Ù„Ù‡ÙƒØ±
void attack_hacker_server(const string& ip, int port) {
    if (is_local_ip(ip)) return; // Ù„Ø§ ØªÙ‡Ø§Ø¬Ù… Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©
    cout << "[*] Attacking hacker server at " << ip << ":" << port << endl;
    
    string command;
    #ifdef _WIN32
        command = "powershell -Command \"Invoke-WebRequest -Uri http://" + ip + ":" + to_string(port) + " -UseBasicParsing\"";
    #else
        command = "wget -qO- http://" + ip + ":" + to_string(port) + " > /dev/null";
    #endif

    for (int i = 0; i < 5; i++) {
        system(command.c_str());
        this_thread::sleep_for(chrono::milliseconds(500));
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ù…Ø³Ø­ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡Ø© ÙˆØ­Ø¸Ø±Ù‡Ø§
void scan_and_block() {
    cout << "[*] Scanning for suspicious connections..." << endl;
    string netstat_output;
    #ifdef _WIN32
        netstat_output = exec_command("netstat -ano | findstr ESTABLISHED");
    #else
        netstat_output = exec_command("netstat -ant | grep ESTABLISHED");
    #endif

    regex netstat_pattern(R"((\d+\.\d+\.\d+\.\d+):(\d+))");
    smatch match;
    stringstream ss(netstat_output);
    string line;

    while (getline(ss, line)) {
        if (regex_search(line, match, netstat_pattern)) {
            string ip = match[1];
            int port = stoi(match[2]);

            if (suspicious_ports.count(port)) {
                cout << "[!] Suspicious connection detected: " << ip << ":" << port << endl;
                block_ip(ip);
                block_port(port);
                attack_hacker_server(ip, port);
            }
        }
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
void log_suspicious_activity(const string& message) {
    ofstream log_file("hacker_protection.log", ios::app);
    if (log_file) {
        log_file << "[LOG] " << message << endl;
        log_file.close();
    }
}

// Ø¢Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ§Ø¹ Ø§Ù„Ø°Ø§ØªÙŠ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¥Ø°Ø§ ØªÙˆÙ‚Ù
void self_defense() {
    while (true) {
        this_thread::sleep_for(chrono::seconds(30));
        string running_processes;
        #ifdef _WIN32
            running_processes = exec_command("tasklist | findstr hacker_protection.exe");
        #else
            running_processes = exec_command("ps aux | grep hacker_protection | grep -v grep");
        #endif

        if (running_processes.empty()) {
            cout << "[!] Warning: Protection system stopped! Restarting..." << endl;
            log_suspicious_activity("Protection system was stopped and restarted.");
            system("./hacker_protection &");
        }
    }
}

// Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
int main() {
    cout << "ğŸ”¥ Smart Hacker Protection System Started! ğŸ”¥" << endl;
    thread defense_thread(self_defense); // ØªØ´ØºÙŠÙ„ Ø¢Ù„ÙŠØ© Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø°Ø§ØªÙŠØ©

    while (true) {
        scan_and_block();
        this_thread::sleep_for(chrono::seconds(10)); // ÙØ­Øµ ÙƒÙ„ 10 Ø«ÙˆØ§Ù†Ù
    }

    defense_thread.join();
    return 0;
}
